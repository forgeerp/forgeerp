name: Generate Documentation

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'frontend/src/**'
      - 'backend/forgeerp/**'
      - '.github/workflows/generate-docs.yml'
    paths-ignore:
      - 'docs/**'

jobs:
  generate-docs:
    name: Generate Visual Documentation
    runs-on: self-hosted
    labels: [contabo, self-hosted, linux, x64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Playwright
        working-directory: ./backend
        run: |
          playwright install chromium
      
      - name: Start services
        run: |
          docker compose up -d
          sleep 10
      
      - name: Create admin user
        run: |
          docker compose exec -T backend python scripts/create_admin_user.py || true
      
      - name: Generate visual documentation
        working-directory: ./backend
        env:
          FRONTEND_URL: http://localhost:3000
          API_URL: http://localhost:8000
        run: |
          python scripts/generate_docs.py
          python scripts/generate_docs_step_by_step.py
      
      - name: Commit and push documentation
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
                 git add docs/operacional/GUIA_*.md docs/operacional/GUIA_*.html docs/operacional/screenshots/*.png 2>/dev/null || true
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“¸ Atualizar documentaÃ§Ã£o visual [skip ci]"
            git push
          fi

