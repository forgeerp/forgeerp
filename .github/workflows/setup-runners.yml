name: Setup Self-Hosted Runners

on:
  workflow_dispatch:
    inputs:
      server_ip:
        description: 'Server IP (DEV/HML or PROD)'
        required: true
        type: string
      server_type:
        description: 'Server type'
        required: true
        type: choice
        options:
          - dev-hml
          - prod
      runner_name:
        description: 'Runner name'
        required: true
        type: string

jobs:
  setup-runner:
    name: Setup Runner on ${{ inputs.server_type }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      
      - name: Install runner on server
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ inputs.server_ip }} << 'EOF'
            # Install Docker
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            
            # Install GitHub Actions Runner
            mkdir -p ~/actions-runner && cd ~/actions-runner
            curl -o actions-runner-linux-x64-2.311.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz
            tar xzf ./actions-runner-linux-x64-2.311.0.tar.gz
            
            # Configure runner
            ./config.sh --url https://github.com/forgeerp/forgeerp --token ${{ secrets.RUNNER_TOKEN }} \
              --name ${{ inputs.runner_name }} \
              --labels contabo,self-hosted,linux,x64,${{ inputs.server_type }} \
              --work _work \
              --replace
            
            # Install as service
            sudo ./svc.sh install
            sudo ./svc.sh start
            
            # Check status
            sudo ./svc.sh status
          EOF

